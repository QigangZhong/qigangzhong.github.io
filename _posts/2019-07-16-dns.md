---
layout: post
title:  "dns"
categories: linux
tags:  linux network
author: 网络
---

* content
{:toc}









## DNS简介

![DNS解析过程](/images/network/dns.jpg)

* linux系统下修改ip的方法：

```bash
# 即时生效
ifconfig eth0 192.168.1.100 netmask 255.255.255.0
# 永久生效
vi /etc/sysconfig/network-scripts/ifcfg-eth0
```

* linux系统下修改default gateway的方法：

```bash
# 即时生效
route add default gw 192.168.1.1
# 永久生效
vi /etc/sysconfig/network-scripts/ifcfg-eth0
```

* linux系统下修改dns的方法：

```bash
# 修改后立即生效，重启也生效
vi /etc/resolv.conf
```

* linux系统下修改hostname主机名称的方法：

```bash
# 即时生效
hostname <newhostname>

# 永久生效
hostnamectl set-hostname <newhostname>
# 上一步如果没有生效则可以执行以下步骤
vi /etc/sysconfig/network
---------------------------------
NETWORKING=yes
HOSTNAME=<newhostname>
---------------------------------
vi /etc/hosts
# 将"127.0.0.1"所在行中的"localhost.localdomain"修改为"新主机名"
# 将"::1"所在行中的"localhost.localdomain"修改为"新主机名"
vi /etc/hostname
# 替换新主机名称
# 重启机器
```

## 测试DNS的办法

```bash
nslookup www.baidu.com
dig +trace www.baidu.com
```

## DNS劫持、DNS污染

[什么是DNS劫持](https://www.simcf.cc/6915.html)

DNS被劫持之后可以通过修改本机固定DNS地址来解决问题

```bash
# 常用的114DNS
DNS1：114.114.114.114
DNS2：114.114.114.115
```

当前DNS服务器一般会将上游DNS服务器解析的结果进行缓存，如果上游DNS服务器将域名指向错误的IP，那所有下游的DNS都会受到污染，可以使用的解决办法：

* 使用VPN代理
* 修改host

## 使用dnsmasq搭建DNS服务器

```bash
# 1. 安装
yum –y install dnsmasq

# 2. 配置
vim /etc/dnsmasq.conf
<---------------------------------
# 指定上游DNS服务器地址配置文件，不指定则默认从/etc/resolv.conf获取
# nameserver 8.8.8.8
# nameserver 8.8.4.4
resolv-file=/etc/resolv.dnsmasq.conf # 内容见上方示例google dns地址
# 指定strict-order，严格按照resolv-file文件中的顺序从上到下进行DNS解析
strict-order
# 定义监听的地址，默认127.0.0.1监听本机所有网卡，如果想让局域网其它机器可以使用本DNS服务器，则逗号隔开添加本机IP地址
listen-address=127.0.0.1,192.168.237.128

# 自定义域名解析到指定ip地址上
address=/abc.com/172.17.65.101

# 告诉dnsmasq使用指定的DNS服务器解析指定的域名
server=/google.com/8.8.8.8
# 配置使用的服务，即本地查询不到时，可通过此服务依次进行查询解析，可配置多个，一般为已知的或代理的外网DNS服务
server=10.10.10.3
server=8.8.8.8
# 为了防止DNS污染，我们使用bogus-nxdomain阻止有问题的DNS服务器进行域名解析
bogus-nxdomain=223.5.5.5
--------------------------------->

# 检查配置是否有问题
dnsmasq --test

# 3. 启动
systemctl start dnsmasq
systemctl enable dnsmasq
systemctl restart dnsmasq
systemctl stop dnsmasq

# 4. 在另外一个机器上编辑DNS服务器为刚才搭建dnsmasq的服务器IP   
vim /etc/resolv.conf
<---------------------------------
nameserver 192.168.237.128
--------------------------------->
```

### 使用docker启动dnsmasq

主机创建一个配置文件，来影射到容器里面dnsmasq的配置文件

```bash
mkdir /dns/conf
vim /dns/conf/dnsmasq.conf
<---------------------------------
log-queries
address=/abc.com/172.17.65.101
--------------------------------->
```

启动下载镜像，启动容器

```bash
docker pull jpillora/dnsmasq

docker run \
    --name dnsmasq \
    -d \
    -p 53:53/udp \
    -p 8888:8080 \
    -v /dns/conf/dnsmasq.conf:/etc/dnsmasq.conf \
    -v /etc/localtime:/etc/localtime:ro \
    -e "HTTP_USER=admin" \
    -e "HTTP_PASS=admin" \
    --restart always \
    jpillora/dnsmasq
```

访问8888端口，查看dnsmasq UI界面，用户名密码在启动参数中

http://192.168.237.128:8888/

## 参考

[DNS-解析、劫持、污染](https://www.cnblogs.com/JohnABC/p/5908658.html)
