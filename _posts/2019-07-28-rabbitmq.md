---
layout: post
title:  "rabbitmq"
categories: tools
tags:  rabbitmq
author: 网络
---

* content
{:toc}









## 安装

### centos7安装

1.首先安装[erlang](http://erlang.org/download/)

```bash
# 下载erlang源码
wget http://erlang.org/download/otp_src_21.1.tar.gz
tar -zxvf otp_src_21.1.tar.gz
cd otp_src_21.1
# erlang编译安装默认是装在/usr/local下的bin和lib中，这里我们将他统一装到/usr/local/erlang中，方便查找和使用
mkdir -p /usr/local/erlang

# 在编译之前，必须安装以下依赖包
yum install -y make gcc gcc-c++ m4 openssl openssl-devel ncurses-devel unixODBC unixODBC-devel java java-devel

# 配置编译安装
./configure --prefix=/usr/local/erlang
make && make install

# 将/usr/local/erlang/bin目录加入到环境变量中
vim /etc/profile
---------------------------------
PATH=$PATH:/usr/local/erlang/bin
---------------------------------
source /etc/profile
```

2.安装对应版本的[rabbitmq](https://github.com/rabbitmq/rabbitmq-server/releases)，rabbitmq和erlang版本对应关系可以查看[说明](https://www.rabbitmq.com/which-erlang.html)

```bash
# 下载解压到/usr/local/目录下
wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.14/rabbitmq-server-generic-unix-3.7.14.tar.xz
tar -xvf rabbitmq-server-generic-unix-3.7.14.tar.xz -C /usr/local/
# 将sbin目录加入到环境变量中方便执行
vim /etc/profile
-------------------------------------------------
PATH=$PATH:/usr/local/rabbitmq_server-3.7.14/sbin
-------------------------------------------------
source /etc/profile
# 启用web管理界面
rabbitmq-plugins enable rabbitmq_management

# 从github上下载配置文件
cd /usr/local/rabbitmq_server-3.7.14/etc/rabbitmq
wget https://raw.githubusercontent.com/rabbitmq/rabbitmq-server/master/docs/rabbitmq.conf.example
mv rabbitmq.conf.example rabbitmq.conf
wget https://raw.githubusercontent.com/rabbitmq/rabbitmq-server/master/docs/advanced.config.example
mv advanced.config.example advanced.config
# 在配置文件中将guest用户解除禁用
sed -i 's/^# loopback_users.guest = true$/loopback_users.guest = false/' rabbitmq.conf

# 常用命令
# 启动停止
# rabbitmq-server命令参考：https://www.rabbitmq.com/rabbitmq-server.8.html
rabbitmq-server start  # 前台启动
rabbitmq-server start_app  # 前台启动
rabbitmq-server -detached  # 后台启动
rabbitmq-server start &  # 后台启动
rabbitmqctl stop
rabbitmqctl stop_app
# 插件管理
rabbitmq-plugins list
rabbitmq-plugins enable XXX   # XXX为插件名
rabbitmq-plugins disable XXX
# 用户管理
rabbitmqctl add_user username password
rabbitmqctl delete_user username
rabbitmqctl change_password username newpassword
rabbitmqctl set_user_tags username tag  # 设置用户角色
rabbitmqctl list_users
# 权限管理
rabbitmqctl list_permissions
rabbitmqctl list_user_permissions username
rabbitmqctl clear_permissions [-p vhostpath] username
rabbitmqctl set_permissions [-p vhostpath] username conf write read
# conf: 一个正则匹配哪些资源能被该用户访问
# write：一个正则匹配哪些资源能被该用户写入
# read：一个正则匹配哪些资源能被该用户读取

rabbitmqctl reset application  # 重置

# 集群操作
rabbitmqctl cluster_status  # 集群状态
rabbitmqctl forget_cluster_node rabbit@rabbit3  # 节点摘除
```

### docker方式安装

```bash
docker pull rabbitmq:3.7.16-management
docker run -d --hostname my-rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.7.16-management
# 访问http://{host}:15672，默认username/pwd为guest/guest
```

### 集群搭建

rabbitmq有两种集群模式，普通集群和镜像集群。普通集群不能高可用，一般生产使用镜像集群实现高可用。镜像集群需要以普通集群作为基础。

#### 普通集群

准备2台centos7机器，按照第一个安装步骤全部安装好rabbitmq，在/etc/hosts中互相配置对方主机名称和ip地址，保证可以通过主机名称ping通对方，假设主机名称为rabbit1、rabbit2

```bash
vim /etc/hosts
-----------------------
192.168.237.128 rabbit1
192.168.237.129 rabbit2
-----------------------
```

以上centos7上安装rabbitmq是通过源码来安装的，在home目录下面会存在一个erlang的文件`$home/.erlang.cookie`，如果是通过yum来安装的话，这个文件应该在`/var/lib/rabbitmq/.erlang.cookie`，或者直接通过`find -name .erlang.cookie`命令来查找一下文件位置，集群节点是通过这个erlang cookie文件来进行通信的，这个文件的内容必须一致，这里将主机rabbit2上的`.erlang.cookie`内容手动修改成与rabbit1一致。

```bash
# 启动主机rabbit1上的rabbitmq-server
rabbitmq-server -detached
# 主机rabbit2上先不启动，执行加入集群操作，加入到rabbit1，加入之后再启动，如果有第三个主机rabbit3也想加入集群，操作一样
rabbitmq-server stop
rabbitmqctl join_cluster rabbit@rabbit1 --ram  # @之前的rabbit为固定单词，@之后是rabbit1的主机名称，RAM节点，默认Disk节点（集群中必须有一个是Disk节点）
rabbitmq-server -detached
```

成功加入集群之后随便访问哪个web ui，都可以看到集群中2个节点信息

```bash
http://192.168.237.128:15672
http://192.168.237.129:15672
```

#### 镜像集群

在搭建完成一个普通集群的基础上执行：

```bash
# 意思表示以test.开头的queue都会复制到各个节点，"^"匹配所有
rabbitmqctl set_policy ha-all "^test\." '{"ha-mode":"all"}'
```

除去上面命令设置的方式以外，在web ui上admin>policy>Add / update a policy也可以添加

在web ui上Queues下面创建一个测试队列，在队列列的Node列，这个队列名称后面显示蓝色`+1`则代表该队列已同步到集群其它节点

## 参考

[Downloading and Installing RabbitMQ](https://www.rabbitmq.com/download.html)

[Centos7 安装rabbitmq详细教程](https://blog.csdn.net/weixin_41004350/article/details/83046842)
